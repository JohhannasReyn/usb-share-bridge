# USB Share Bridge v2.0 - Architecture Diagrams

## System Architecture Overview

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         CLIENT LAYER                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â•‘
â•‘  â”‚USB Host 1â”‚  â”‚USB Host 2â”‚  â”‚SMB Clientâ”‚  â”‚HTTP API  â”‚            â•‘
â•‘  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â•‘
â•šâ•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        â”‚             â”‚             â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    USB BRIDGE CONTROLLER                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
â•‘  â”‚                    clientWriteFile()                          â”‚ â•‘
â•‘  â”‚                    clientReadFile()                           â”‚ â•‘
â•‘  â”‚                    clientDeleteFile()                         â”‚ â•‘
â•‘  â”‚                    Client API Layer                           â”‚ â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                             â”‚
                             â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   FILE OPERATION QUEUE                             â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  Queue:  [Op1] â†’ [Op2] â†’ [Op3] â†’ [Op4] â†’ [Op5]               â”‚  â•‘
â•‘  â”‚  Status:  âˆš      âŸ³       â¸      â³       â³                 â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                                                                    â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚ Buffer Manager â”‚   â”‚ Queue Processor â”‚   â”‚ Status Tracker   â”‚   â•‘
â•‘  â”‚ Allocate/Free  â”‚   â”‚ Background      â”‚   â”‚ Callbacks        â”‚   â•‘
â•‘  â”‚ Space Check    â”‚   â”‚ Thread          â”‚   â”‚ Statistics       â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                             â”‚
                             â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      LOCAL BUFFER STORAGE                          â•‘
â•‘                        /data/buffer/                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  buffer_client1_12345.tmp    [====     ]  4.2 GB             â”‚  â•‘
â•‘  â”‚  buffer_client2_12346.tmp    [==        ]  1.8 GB            â”‚  â•‘
â•‘  â”‚  buffer_client3_12347.tmp    [=========  ]  8.5 GB           â”‚  â•‘
â•‘  â”‚                                                              â”‚  â•‘
â•‘  â”‚  Total: 14.5 GB / 20 GB (72% used)                           â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                             â”‚
                             â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      MUTEX LOCKER                                  â•‘
â•‘                   (Access Control)                                 â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  Current Mode: BOARD_MANAGED                                 â”‚  â•‘
â•‘  â”‚  Access Holder: BOARD                                        â”‚  â•‘
â•‘  â”‚  Queue Status: RUNNING                                       â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                                                                    â•‘
â•‘  Modes:                                                            â•‘
â•‘    â€¢ BOARD_MANAGED    â† Normal operation (queue active)            â•‘
â•‘    â€¢ DIRECT_USB       â† USB gadget mode (queue paused)             â•‘
â•‘    â€¢ DIRECT_NETWORK   â† Direct network access (queue paused)       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                             â”‚
                             â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   EXTERNAL USB DRIVE                               â•‘
â•‘                   /mnt/usbdrive/                                   â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  ðŸ“ documents/                                               â”‚  â•‘
â•‘  â”‚  ðŸ“ photos/                                                  â”‚  â•‘
â•‘  â”‚  ðŸ“ videos/                                                  â”‚  â•‘
â•‘  â”‚  ðŸ“ music/                                                   â”‚  â•‘
â•‘  â”‚                                                              â”‚  â•‘
â•‘  â”‚  Capacity: 2 TB    Used: 1.2 TB    Free: 800 GB              â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## Operation Flow: Small File Write

```
TIMELINE â†’

Client                Queue              Buffer              Drive
  â”‚                     â”‚                   â”‚                  â”‚
  â”‚ 1. Write Request    â”‚                   â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                  â”‚
  â”‚                     â”‚                   â”‚                  â”‚
  â”‚ 2. Operation ID     â”‚                   â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                  â”‚
  â”‚                     â”‚                   â”‚                  â”‚
  â”‚                     â”‚ 3. Allocate       â”‚                  â”‚
  â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
  â”‚                     â”‚                   â”‚                  â”‚
  â”‚ 4. Upload to Buffer â”‚                   â”‚                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
  â”‚                     â”‚                   â”‚                  â”‚
  â”‚                     â”‚ 5. Process Queue  â”‚                  â”‚
  â”‚                     â”‚ (Background)      â”‚                  â”‚
  â”‚                     â”‚                   â”‚                  â”‚
  â”‚                     â”‚                   â”‚ 6. Write to Driveâ”‚
  â”‚                     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                   â”‚                  â”‚
  â”‚                     â”‚                   â”‚ 7. Confirm       â”‚
  â”‚                     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                     â”‚                   â”‚                  â”‚
  â”‚                     â”‚ 8. Release Buffer â”‚                  â”‚
  â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
  â”‚                     â”‚                   â”‚                  â”‚
  â”‚ 9. Completion       â”‚                   â”‚                  â”‚
  â”‚    Callback         â”‚                   â”‚                  â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                  â”‚
  â”‚                     â”‚                   â”‚                  â”‚

Total Time: ~1-2 seconds for 10MB file
```

## Operation Flow: Large File Write (Requires Direct Access)

```
TIMELINE â†’

Client                Queue              MutexLocker         Drive
  â”‚                     â”‚                     â”‚                â”‚
  â”‚ 1. Write Request    â”‚                     â”‚                â”‚
  â”‚    (6GB file)       â”‚                     â”‚                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚                     â”‚ 2. Check Size       â”‚                â”‚
  â”‚                     â”‚    Too Large!       â”‚                â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚ 3. DIRECT_ACCESS    â”‚                     â”‚                â”‚
  â”‚    REQUIRED         â”‚                     â”‚                â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚ 4. Request Direct   â”‚                     â”‚                â”‚
  â”‚    Access           â”‚                     â”‚                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚                     â”‚ 5. Pause Queue      â”‚                â”‚
  â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚                     â”‚                     â”‚ 6. Enable USB  â”‚
  â”‚                     â”‚                     â”‚    Gadget Mode â”‚
  â”‚                     â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚ 7. Access Granted   â”‚                     â”‚                â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚ 8. Direct Write (Appears as USB Drive)    â”‚                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚ 9. Release Access   â”‚                     â”‚                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚                     â”‚                     â”‚ 10. Disable    â”‚
  â”‚                     â”‚                     â”‚     Gadget     â”‚
  â”‚                     â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                     â”‚                â”‚
  â”‚                     â”‚ 11. Resume Queue    â”‚                â”‚
  â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
  â”‚                     â”‚                     â”‚                â”‚

Total Time: ~180 seconds for 6GB file (same as v1.x, but no waiting)
```

## Access Mode State Machine

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   BOARD_MANAGED      â”‚
                     â”‚  (Default State)     â”‚
                     â”‚                      â”‚
                     â”‚  â€¢ Queue Running     â”‚
                     â”‚  â€¢ Board has access  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚       â”‚
            Large File      â”‚       â”‚    Release
            Detected        â”‚       â”‚    Direct Access
                            â”‚       â”‚
                            â–¼       â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   DIRECT_USB            â”‚
                  â”‚                         â”‚
                  â”‚  â€¢ Queue Paused         â”‚
                  â”‚  â€¢ USB Gadget Enabled   â”‚
                  â”‚  â€¢ Client has access    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ â”‚
            OR              â”‚ â”‚
                            â”‚ â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   DIRECT_NETWORK         â”‚
                  â”‚                          â”‚
                  â”‚  â€¢ Queue Paused          â”‚
                  â”‚  â€¢ SMB/HTTP Direct       â”‚
                  â”‚  â€¢ Client has access     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Special States:
  â€¢ BLOCKED: Maintenance mode, all access denied
  â€¢ Can transition from any state to BLOCKED
  â€¢ Returns to BOARD_MANAGED after unblock
```

## Buffer Space Management

```
Buffer Capacity: 20 GB
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Current Usage:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client 1    â”‚ Client 2     â”‚       Available       â”‚
â”‚ 4.2 GB      â”‚ 1.8 GB       â”‚       14.0 GB         â”‚
â”‚ [====]      â”‚ [==]         â”‚       [          ]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

New Request: 8 GB file
  â€¢ Check: 8 GB <= 14 GB Available? YES âœ“
  â€¢ Action: Allocate buffer, queue operation

New Request: 16 GB file
  â€¢ Check: 16 GB <= 14 GB Available? NO âœ—
  â€¢ Action: Mark as DIRECT_ACCESS_REQUIRED

Buffer Allocation Strategy:
  1. First-fit allocation
  2. Best-effort deduplication
  3. Automatic cleanup of completed operations
  4. Periodic garbage collection
```

## Multi-Client Scenario

```
Time â†’    0s      1s      2s      3s      4s      5s      6s
          â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
Client A  â”œâ”€Writeâ”€â”¤       â”‚       â”‚     âˆš â”‚       â”‚       â”‚
          â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
Client B  â”‚       â”œâ”€â”€Readâ”€â”¤       â”‚       â”‚     âˆš â”‚       â”‚
          â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
Client C  â”‚       â”‚       â”œâ”€Writeâ”€â”¤       â”‚       â”‚     âˆš â”‚
          â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
          â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
Queue     [A]     [A,B]   [A,B,C] [B,C]   [C]     []      []
          â”‚       â”‚       â”‚       â”‚       â”‚       â”‚       â”‚
Drive     Write A Read B  Write C Idle    Idle    Idle    Idle

Note: All operations queued immediately, processed sequentially
      Clients don't wait for each other during queueing
```

## Performance Comparison

```
Scenario: Writing 10 files of 5MB each

v1.x (Direct Access Model):
â”œâ”€ Get Access (USB Switch)     : 2s
â”œâ”€ Write File 1                 : 0.5s
â”œâ”€ Write File 2                 : 0.5s
â”œâ”€ ...
â”œâ”€ Write File 10                : 0.5s
â”œâ”€ Release Access (USB Switch)  : 2s
â””â”€ Total Time                   : ~9s per client

With multiple clients: Sequential access only!
Client A: 9s, Client B waits 9s then 9s = 18s, Client C waits 18s then 9s = 27s


v2.0 (Queue Model):
â”œâ”€ Queue All Files             : <0.1s (instant)
â”œâ”€ Background Processing:
â”‚   â”œâ”€ Write File 1            : 0.5s
â”‚   â”œâ”€ Write File 2            : 0.5s
â”‚   â”œâ”€ ...
â”‚   â””â”€ Write File 10           : 0.5s
â””â”€ Total Processing Time       : ~5s

With multiple clients: Concurrent queueing!
Client A: Queues in 0.1s, processes in background
Client B: Queues in 0.1s (no wait!), processes after A
Client C: Queues in 0.1s (no wait!), processes after B
All clients happy within 1 second, processing happens in background
```

Legend:
  âœ“  = Completed successfully
  âŸ³  = In progress
  â¸  = Paused (waiting for direct access)
  â³ = Queued (waiting to be processed)
  âš   = Error or requires attention
```